<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Music Search API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        background: #1db954;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background: #1ed760;
      }
      .result {
        margin: 20px 0;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 5px;
      }
      .token-display {
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Music Search API Test</h1>

    <div id="auth-section">
      <h2>Authentication</h2>
      <button onclick="login()">Login with Spotify</button>
      <button onclick="logout()">Logout</button>
      <button onclick="getProfile()">Get My Profile</button>

      <div id="token-info" class="result" style="display: none">
        <h3>Token:</h3>
        <div id="token-display" class="token-display"></div>
      </div>
    </div>

    <div id="search-section">
      <h2>Search Music</h2>
      <input
        type="text"
        id="searchQuery"
        placeholder="Enter search query"
        style="padding: 8px; width: 300px"
      />
      <select id="searchType" style="padding: 8px">
        <option value="track">Track</option>
        <option value="artist">Artist</option>
        <option value="album">Album</option>
      </select>
      <button onclick="searchMusic()">Search</button>

      <div id="search-results" class="result"></div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000";
      let authToken = localStorage.getItem("spotify_token");

      // Check for token in URL (from OAuth callback)
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get("token");
      if (tokenFromUrl) {
        authToken = tokenFromUrl;
        localStorage.setItem("spotify_token", authToken);
        document.getElementById("token-display").textContent = authToken;
        document.getElementById("token-info").style.display = "block";
        // Clean URL
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      function login() {
        window.location.href = `${API_BASE}/auth/spotify`;
      }

      function logout() {
        if (!authToken) {
          alert("Not logged in");
          return;
        }

        fetch(`${API_BASE}/logout`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            localStorage.removeItem("spotify_token");
            authToken = null;
            document.getElementById("token-info").style.display = "none";
            alert("Logged out successfully");
          })
          .catch((error) => console.error("Error:", error));
      }

      function getProfile() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        fetch(`${API_BASE}/me`, {
          headers: {
            Authorization: `Bearer ${authToken}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("search-results").innerHTML = `
                    <h3>Your Profile:</h3>
                    <p><strong>Name:</strong> ${data.display_name}</p>
                    <p><strong>Email:</strong> ${data.email}</p>
                    <p><strong>Spotify ID:</strong> ${data.id}</p>
                `;
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("search-results").innerHTML =
              '<p style="color: red;">Error getting profile</p>';
          });
      }

      function searchMusic() {
        if (!authToken) {
          alert("Please login first");
          return;
        }

        const query = document.getElementById("searchQuery").value;
        const type = document.getElementById("searchType").value;

        if (!query) {
          alert("Please enter a search query");
          return;
        }

        fetch(
          `${API_BASE}/search?q=${encodeURIComponent(query)}&type=${type}`,
          {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            displaySearchResults(data, type);
          })
          .catch((error) => {
            console.error("Error:", error);
            document.getElementById("search-results").innerHTML =
              '<p style="color: red;">Error searching</p>';
          });
      }

      function displaySearchResults(data, type) {
        const resultsDiv = document.getElementById("search-results");

        if (data[type + "s"] && data[type + "s"].items.length > 0) {
          let html = `<h3>Search Results (${type}s):</h3>`;

          data[type + "s"].items.slice(0, 5).forEach((item) => {
            if (type === "track") {
              html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                                <p><strong>${item.name}</strong> by ${
                item.artists[0].name
              }</p>
                                <p>Album: ${item.album.name}</p>
                                ${
                                  item.preview_url
                                    ? `<audio controls><source src="${item.preview_url}" type="audio/mpeg"></audio>`
                                    : ""
                                }
                            </div>
                        `;
            } else if (type === "artist") {
              html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                                <p><strong>${item.name}</strong></p>
                                <p>Followers: ${item.followers.total}</p>
                                <p>Genres: ${item.genres.join(", ")}</p>
                            </div>
                        `;
            } else if (type === "album") {
              html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                                <p><strong>${item.name}</strong> by ${item.artists[0].name}</p>
                                <p>Release Date: ${item.release_date}</p>
                                <p>Tracks: ${item.total_tracks}</p>
                            </div>
                        `;
            }
          });

          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = "<p>No results found</p>";
        }
      }

      // Show token if already logged in
      if (authToken) {
        document.getElementById("token-display").textContent = authToken;
        document.getElementById("token-info").style.display = "block";
      }
    </script>
  </body>
</html>
